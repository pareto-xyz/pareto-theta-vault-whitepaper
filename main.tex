\documentclass[hidelinks, 12pt]{article}

\usepackage{subcaption}
\usepackage{caption}
\usepackage{fullpage}
\usepackage[utf8]{inputenc}
\usepackage{appendix}
\usepackage{hyperref}
\usepackage{float}

\parskip = \baselineskip
\setlength{\parindent}{0pt}

\title{Pareto Replicating Theta Vaults}

\author{Mike Wu, Will McTighe \\ \small\texttt{\{mike, will\}@paretolabs.xyz}}

\date{February 2022}

\begin{document}

\maketitle

\tableofcontents

\begin{abstract}
Theta Vaults are a simple on-chain structured product that runs an automated strategy to sell rolling weekly out-the-money covered calls in which the premium is returned to vault participants as yield.
Traditionally, Theta Vaults face two main challenges: first, they require oracles which can introduce new vulnerabilities; second, the yield is capped by the efficiency of a matching process to find options buyers.
In this paper, we present the design for Theta Vaults built on top of replicating market makers that approximate a Black-Scholes covered call.
Beyond covered calls, an ecosystem of efficient and secure options vaults can be built by a similar replication.
\end{abstract}

\section{Preface}

This paper is a technical introduction to Pareto Replicating Theta Vaults, a redesign of the yield instrument popularized by Ribbon Finance. In the following, we describe how to construct Theta Vaults on top of replicating market makers (RMMs), in which selling a covered call is equivalent to being a liquidity provider. Our primary hypothesis is that the ability of RMMs to replicate a wide array of structured products can be used to design an options ecosystem with token compositionality as a first-class citizen. With regards to Theta Vaults in particular, RMMs offer a oracle-free and auction-free solution that users may find attractive. In the following sections, we first provide background information then present the mechanism underlying the Replicating Theta Vault (RTV).

\paragraph{[6/15/22]} The alpha product for Pareto RTVs is currently under development. Please reach out to \texttt{mike@paretolabs.xyz} if you have any questions.

\section{Background}

We provide an overview for concepts required to understand RTVs. We opt to provide a high-level explanation and leave a more mathematical treatment to the cited work.

\subsection{Constant Function Market Makers}

Constant function market makers (CFMMs) are a family of automated market makers (AMMs) used as token swap mechanisms on public blockchains. Liquidity providers (LPs) lend a token pair (e.g. Ethereum and USDC) to a supply of reserves managed by a smart contract. Users wishing to swap tokens can call the smart contract, paying a small fee that is rewarded to the LPs. However, the contract is programmed to ensure that a function of the token reserves remains constant, hence the name ``constant function''. This function is called the trading function or the invariant.

To introduce the notation we will carry throughout this paper, let $x, y \in \mathbf{R}_+$ be reserves for two tokens X and Y, and $\psi: \mathbf{R} \times \mathbf{R} \rightarrow \mathbf{R}$ be an invariant. For a fixed level of liquidity, we have $\psi(x, y) = k$ for a constant $k \in \mathbf{R}$. A trade of $\Delta x$ of token X for $\Delta y$ of token Y is allowed if and only if $\psi(x - \Delta x, y + \Delta y) = k$ for the same value $k$. For any CFMM, the (marginal) price of token Y in token X is a function of the reserves:
\[S(x) = \left(-\frac{dy}{dx}\right).\]
A common invariant is the product of the two reserves ($\psi = x\cdot y$), used by Uniswap \cite{angeris2019analysis,adams2021uniswap} and Balancer \cite{martinelli2019non} among others.
In this case, the marginal price is simply $\left(\frac{y}{x}\right)$.
Other invariants include the arithmetic sum ($\psi = x + y$) along with more complex ``mixtures'' of sum and product invariants such as Yieldspace \cite{niemerg2020yieldspace} or Curve \cite{egorov2021automatic}.

CFMMs and the broader class of AMMs, stand as an alternative to more traditional orderbook markets that require matching between buyers and sellers at various prices. CFMMs require no middlemen, expose transparent prices, have efficiency benefits as trades execute immediately, are oracle-free and hence less vulnerable to malicious actors, and are more robust under black-swan events. Due to these advantages, CFMMs have grown to dominant the swap market, with Uniswap being the largest DEX and fourth largest exchange.
% Much more can be said about CFMMs, including impermanent loss and the structure of trading fees, but for this discussion, we recommend reading \cite{angeris2019analysis}.

\subsection{Replicating Market Makers}

Given a CFMM with a specific invariant, what is the payoff to its liquidity providers? Generally, given $x$ units of a token valued at price $p_x$ on some reference market, my payoff is simply what I can sell my assets for. In this case,  $p_x \cdot x$. Given two tokens with $x$ units of X and $y$ units of Y, we can write the total payoff as:
\[V(p_x, p_y) = p_x\cdot x + p_y \cdot y = p_x (x + S(x)y_\psi(x))\]
where $S(x)$ is the marginal price and the notation $y_\psi(x)$ represents solving for $y$ in terms of $x$ with respect to the invariant $\psi$.
Altogether, $S(x)y_\psi(x)$ is the amount of token X we can get for $y$ units of token Y in the CFMM.
The product invariant has a payoff function that suffers from divergence loss \cite{angeris2019analysis}. If the price does not deviate too much from the initial price that a LP deposited tokens at, the LP makes a profit. However, if the price changes, the LP loses money that scales with the magnitude of the price change. For LPs with a directional belief in the token price, such a payoff is not optimal.

This begs the question: given a payoff function, what is corresponding invariant such that being an LP in that market would provide said payoff? We can imagine all kinds of interesting payoff functions that might be attractive to LPs seeking to hedge or take on risk.  Above, we showed how to derive a payoff $V$ from an invariant $\psi$, but what about deriving an invariant from a payoff? This is the core concept behind ``Replicating Market Makers'' or RMMs.

RMMs \cite{angeris2021replicating} show that for all payoff functions $V$ that satisfy a set of mathematical properties\footnote{The constraints are non-negativity, concavity, and 1-homogeneity, with the final being the strictest.}, one can derive an invariant by solving a convex optimization problem,
\[ \psi_V(x, y) = \inf_{p_x, p_y} \{ p_x \cdot x + p_y \cdot y - V(p_x, p_y) \}. \]
The method goes further to show that the payoff function and the invariant are Fenchel conjugates of one another, a surprising result. So, to enable LPs to achieve a payoff $V$, one can design a CFMM with the invariant $\psi_V$. We say that $\psi_V$ ``replicates'' the payoff $V$. In Section~\ref{sec:coveredcall}, we will focus on an RMM that replicates the payoff of a covered call option.

\subsection{Options Review}

Before then, we quickly review the basics of a covered call. Broadly, an option is a derivative instrument around the right to buy or sell an underlying asset if its price is within a pre-specified range. The buyer of an option pays a premium to the seller in exchange for that right. A \textit{call} option is a specific kind of option with a set ``strike price'' such that if the underlying asset price (also called the spot price) is above the strike, then the buyer may ``exercise'' the option, meaning purchase the underlying at the strike -- not the current price which is higher than the strike price. It is required for the seller to own the underlying asset upfront when selling a call option. Only if the option is exercised must the seller purchase and transfer the underlying asset to the buyer. Additionally, options have expiry dates after which the contract between the buyer and seller no longer hold. We focus on European options in which the buyer can only exercise the option at the expiry date, not before.

Pricing an option means setting the value of the premium to the expected value of the profits from the option being exercised. In generality, this is difficult to  reason about. The best practice is to assume the  Black-Scholes model which makes simplifications to asset returns, volatility, and market dynamics among many others. Despite not being faithful to real world markets, the model is still useful to determine rational prices of options. The Black-Scholes formula defines the price of a call option as
\[\textup{premium} = p N(d_1) - K e^{-rt} N(d_2)\]
where $d_1 = \left( \frac{\log(p/K) + (\sigma^2/2)\tau}{\sigma\sqrt{\tau}}\right)$ and $d_2 = d_1 - \sigma\sqrt{\tau}$. Notation-wise, $p$ is the spot price, $K$  the strike price, $\tau = T-t$ where $T$ is the expiry time and $t$ the current time, $r$ the risk-free rate (assumed as constant), and $\sigma$ the implied volatility (assumed as constant).

\subsection{Replicating Black-Scholes Covered Calls}
\label{sec:coveredcall}

TODO.

\section{Replicating Theta Vaults}

TODO.

\subsection{Mechanism}

TODO.

\subsection{Options Strategy}

TODO.

\subsection{Fee Structure}

TODO.


\section{Limitations and Future Work}

TODO.

\section{Conclusion}

TODO.

\bibliographystyle{unsrt}
\bibliography{main}

\end{document}
