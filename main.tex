\documentclass[hidelinks, 12pt]{article}

\usepackage{subcaption}
\usepackage{caption}
\usepackage{fullpage}
\usepackage[utf8]{inputenc}
\usepackage{appendix}
\usepackage{hyperref}
\usepackage{float}

\parskip = \baselineskip
\setlength{\parindent}{0pt}

\title{Pareto Replicating Theta Vaults}

\author{Mike Wu, Will McTighe \\ \small\texttt{\{mike, will\}@paretolabs.xyz}}

\date{February 2022}

\begin{document}

\maketitle

\tableofcontents

\begin{abstract}
Theta Vaults are a simple on-chain structured product that runs an automated strategy to sell rolling weekly out-the-money covered calls in which the premium is returned to vault participants as yield.
Traditionally, Theta Vaults face two main challenges: first, they require oracles which can introduce new vulnerabilities; second, the yield is capped by the efficiency of a matching process to find options buyers.
In this paper, we present the design for Theta Vaults built on top of replicating market makers that approximate a Black-Scholes covered call.
Beyond covered calls, an ecosystem of efficient and secure options vaults can be built by a similar replication.
\end{abstract}

\section{Preface}

This paper is a technical introduction to Pareto Replicating Theta Vaults, a redesign of the yield instrument popularized by Ribbon Finance. In the following, we describe how to construct Theta Vaults on top of replicating market makers (RMMs), in which selling a covered call is equivalent to being a liquidity provider. Our primary hypothesis is that the ability of RMMs to replicate a wide array of structured products can be used to design an options ecosystem with token compositionality as a first-class citizen. With regards to Theta Vaults in particular, RMMs offer a oracle-free and auction-free solution that users may find attractive. In the following sections, we first provide background information then present the mechanism underlying the Replicating Theta Vault (RTV).

\paragraph{[6/15/22]} The alpha product for Pareto RTVs is currently under development. Please reach out to \texttt{mike@paretolabs.xyz} if you have any questions.

\section{Background}

We provide an overview for concepts required to understand RTVs. We opt to provide a high-level explanation and leave a more mathematical treatment to the cited work.

\subsection{Constant Function Market Makers}

Constant function market makers (CFMMs) are a family of automated market makers (AMMs) used as token swap mechanisms on public blockchains. Liquidity providers (LPs) lend a token pair (e.g. Ethereum and USDC) to a supply of reserves managed by a smart contract. Users wishing to swap tokens can call the smart contract, paying a small fee that is rewarded to the LPs. However, the contract is programmed to ensure that a function of the token reserves remains constant, hence the name ``constant function''. This function is called the trading function or the invariant.

To introduce the notation we will carry throughout this paper, let $x, y \in \mathbf{R}_+$ be reserves for two tokens X and Y, and $\psi: \mathbf{R} \times \mathbf{R} \rightarrow \mathbf{R}$ be an invariant. For a fixed level of liquidity, we have $\psi(x, y) = k$ for a constant $k \in \mathbf{R}$. A trade of $\Delta x$ of token X for $\Delta y$ of token Y is allowed if and only if $\psi(x - \Delta x, y + \Delta y) = k$ for the same value $k$. For any CFMM, the (marginal) price of token Y in token X is a function of the reserves:
\[S(x) = \left(-\frac{dy}{dx}\right).\]
A common invariant is the product of the two reserves ($\psi = x\cdot y$), used by Uniswap \cite{angeris2019analysis,adams2021uniswap} and Balancer \cite{martinelli2019non} among others.
In this case, the marginal price is simply $\left(\frac{y}{x}\right)$.
Other invariants include the arithmetic sum ($\psi = x + y$) along with more complex ``mixtures'' of sum and product invariants such as Yieldspace \cite{niemerg2020yieldspace} or Curve \cite{egorov2021automatic}.

CFMMs and the broader class of AMMs, stand as an alternative to more traditional orderbook markets that require matching between buyers and sellers at various prices. CFMMs require no middlemen, expose transparent prices, have efficiency benefits as trades execute immediately, are oracle-free and hence less vulnerable to malicious actors, and are more robust under black-swan events. Due to these advantages, CFMMs have grown to dominant the swap market, with Uniswap being the largest DEX and fourth largest exchange.
% Much more can be said about CFMMs, including impermanent loss and the structure of trading fees, but for this discussion, we recommend reading \cite{angeris2019analysis}.

\subsection{Replicating Market Makers}
\label{sec:rmm}

Given a CFMM with a specific invariant, what is the payoff to its liquidity providers? Generally, given $x$ units of a token valued at price $p_x$ on some reference market, my payoff is simply what I can sell my assets for. In this case,  $p_x \cdot x$. Given two tokens with $x$ units of X and $y$ units of Y, we can write the total payoff as:
\[V(p_x, p_y) = p_x\cdot x + p_y \cdot y = p_x (x + S(x)\cdot y_\psi(x))\]
where $S(x)$ is the marginal price and the notation $y_\psi(x)$ represents solving for $y$ in terms of $x$ with respect to the invariant $\psi$.
Altogether, $S(x)\cdot y_\psi(x)$ is the amount of token X we can get for $y$ units of token Y in the CFMM.
The product invariant has a payoff function that suffers from divergence loss \cite{angeris2019analysis}. If the price does not deviate too much from the initial price that a LP deposited tokens at, the LP makes a profit. However, if the price changes, the LP loses money that scales with the magnitude of the price change. For LPs with a directional belief in the token price, such a payoff is not optimal.

This begs the question: given a payoff function, what is corresponding invariant such that being an LP in that market would provide said payoff? We can imagine all kinds of interesting payoff functions that might be attractive to LPs seeking to hedge or take on risk.  Above, we showed how to derive a payoff $V$ from an invariant $\psi$, but what about deriving an invariant from a payoff? This is the core concept behind ``Replicating Market Makers'' or RMMs.

RMMs \cite{angeris2021replicating} show that for all payoff functions $V$ that are non-negative, concave, and 1-homogenous (with this final one being the strictest), one can derive an invariant by solving a convex optimization problem,
\[ \psi_V(x, y) = \inf_{p_x, p_y} \{ p_x \cdot x + p_y \cdot y - V(p_x, p_y) \}. \]
The method goes further to show that the payoff function and the invariant are Fenchel conjugates of one another, a surprising result. So, to enable LPs to achieve a payoff $V$, one can design a CFMM with the invariant $\psi_V$. We say that $\psi_V$ ``replicates'' the payoff $V$. In Section~\ref{sec:coveredcall}, we will focus on an RMM that replicates the payoff of a covered call option.

\subsection{Options Review}

Before then, we quickly review the basics of a covered call. Broadly, an option is a derivative instrument around the right to buy or sell an underlying asset if its price is within a pre-specified range. The buyer of an option pays a premium to the seller in exchange for that right. A \textit{call} option is a specific kind of option with a set ``strike price'' such that if the underlying asset price (also called the spot price) is above the strike, then the buyer may ``exercise'' the option, meaning purchase the underlying at the strike. Critically, this is less than the spot price meaning the buyer makes profit. It is not required for the seller to own the underlying asset upfront when selling a call. Only if the option is exercised must the seller purchase and transfer the underlying asset to the buyer. Additionally, options have expiry times after which the contract between the buyer and seller no longer holds. We focus on European options in which the buyer can only exercise at the expiry time, not before.

Pricing an option means setting the value of the premium to the expected value of the profits from the option being exercised. In generality, this is difficult to  reason about. The best practice is to assume the  Black-Scholes model which makes simplifications to asset returns, volatility, and market dynamics among many others. Despite not being faithful to real world markets, the model is still useful to determine rational prices of options. The Black-Scholes formula defines the price of a call option as
\[\textup{premium} = p N(d_1) - K e^{-rt} N(d_2)\]
where $d_1 = \left( \frac{\log(p/K) + (\sigma^2/2)\tau}{\sigma\sqrt{\tau}}\right)$ and $d_2 = d_1 - \sigma\sqrt{\tau}$. Notation-wise, $p$ is the spot price, $K$  the strike price, $\tau = T-t$ where $T$ is the expiry time and $t$ the current time, $r$ the risk-free rate (assumed as constant), and $\sigma$ the implied volatility (assumed as constant).

A property of options is that it's value decreases as time approaches the expiry time, also called ``theta decay''. Intuitively, an option with more time has more potential for favorable price fluctuation, which is valuable to the buyer (e.g. it could be that tomorrow the price of a call option exceeds the strike at which point the buyer can exercise). This benefit is priced into the Black-Scholes model, and hence priced into the premium paid by the buyer.
% That expiry time ($\tau = 0$), the theta value is zero.

Finally, a \textit{covered call} is a structured product in which one sells a call option but also buys the underlying asset, thereby ``covering'' the call position if it is exercised. Intuitively, selling a covered call bounds the seller's upside in return for premium. The seller is guaranteed to earn premium paid by the buyer but loses money (albeit modestly) if the spot price exceeds the strike price. In other words, the seller's potential gains from the underlying asset appreciating is capped. As such, covered calls are not very risky products. A common strategy is to sell ``out-the-money'' covered calls, meaning the strike price is above the current spot price. Here, the seller is betting that price will not increase past the strike and earn premium whereas the buyer has a directional view that the price will exceed the strike. One can also view a covered call as a hedge against the long position on the underlying.

\subsection{Replicating Black-Scholes Covered Calls}
\label{sec:coveredcall}

In Section~\ref{sec:rmm}, we showed a technique to derive invariants from payoff functions assuming three constraints on the payoff function. We now observe that the payoff of a covered call is indeed non-negative, concave, and 1-homogenous. In other words, there exists an invariant that replicates the covered call premium. The Primitive RMM-01\footnote{Built by the Primitive team. See \url{https://primitive.xyz/whitepaper-rmm-01.pdf}.} invariant is
\[y - K\Phi(\Phi^{-1}(1-x)-\sigma\sqrt{\tau}) = k\]
where $\Phi$ is a Gaussian CDF and all other variables are as defined in previous sections. The marginal price can be written as $S(x) = Ke^{\Phi^{-1}(1-x)\sigma\sqrt{\tau}}e^{-\frac{1}{2}\sigma^2\tau}$.

To properly replicate covered calls with theta decay, it is important to optimally set the (swap) fee. We leave the details of experiments with fees to the RMM-01 whitepaper. Unlike Uniswap, which is primary meant for traders to swap tokens, the primary users of RMM-01 are LPs who seek to obtain covered call payoffs. The other end of this market is dominated by arbitrageurs who seek to close the price gap between RMM-01 and other markets such as Uniswap. Through arbitrage trades, fees accumulate to LPs, approximating the true covered call premium. That is, there exists a zero-sum duality  between LPs and arbitrageurs. RMMs take advantage of this duality for replication.

\section{Theta Vaults}
\label{sec:theta}

We review the design of Theta Vaults, as implemented by Ribbon Finance and similar protocols. A Theta Vault sells out-the-money covered calls every week ad infinitum.

Each week, a new round begins. Participants deposit the underlying asset into a vault. At fixed intervals throughout a round, the assets are aggregated and placed as collateral to sell covered call options. For instance, Ribbon uses Opyn to mint options tokens (also called oTokens). This process is gas efficient as the vault makes a single transaction to Opyn for thousands of users at once. The covered call tokens are sold for premium via a public auction (Ribbon uses Gnossis). Market makers can buy the covered calls, effectively betting that the spot price will exceed the strike. If so, the vault's collaterals are relinquished to the buyers. Otherwise, the collateral is returned to the sellers along with the premium as yield.
A manager decides on the weekly strategy to set strike price. The manager may be an automated contract (e.g. set strike to be a percentage above current spot price using an oracle) or a priviledged user who can manually set strike price.

Essentially, the yield accrued by users comes from the time value of an option, in other words Theta decay (hence the name). Users of Theta Vaults do not need to actively manage their positions. Their actions are limited to depositing and withdrawing the underlying. The amount of yield that users earn is strictly bounded by the vault's ability to find buyers within a constrained time interval. In Ribbon, Gnossis auctions are open for only one hour. Unmatched short positions produce no yield since no premium is being paid. Much like orderbooks, a traditional marketplace matching buyers and sellers is difficult to run efficiently on-chain. Next, we propose an alternative design using RMMs.

\section{Replicating Theta Vaults}

We propose to offer Theta Vaults through selling covered calls replicated by RMM-01, as first described in \cite{sterrett2022replicating}. In short, doing so would replace the matching of buyers to sellers with rational arbitrage in an AMM pool -- a potentially more efficient design.

\subsection{Mechanism}

The mechanism of a ``Replicating Theta Vault'' (RTV) is largely reminiscent of traditional Theta Vaults, though with some important distinctions.

In each round, users seeking yield will deposit a token pair consisting of a risky asset (e.g. Ethereum) and a stable asset (e.g. USDC) into an RMM-01 pool with a one week expiry and a set strike price in return for an LP token. Throughout the round, arbitrageurs will pay fees to trade tokens in the RMM-01 pool to bridge the price gap with external markets like Uniswap or Coinbase. These fees are directly reinvested into the pool's reserves. At the expiry time, users can burn their LP tokens to retrieve liquidity in the token pair. The payoff experienced by users is the premium from a covered call by replication. At the end of the round, the RMM-01 pool expires, and liquidity is either withdrawn by users or automatically moved to a new RMM-01 pool with a different strike price and an expiry date one week from now. Much like Theta Vaults, RTVs continue to roll over liquidity ad infinitum.

No auction nor matching process is required. Technically, there are no buyers of said covered calls as no options are truly being sold, only replicated. The opposing end of an RMM market is arbitrageurs. As long as arbitrageurs are making rational trades for alpha, LPs will closely replicate the expected payoff. In other words, a single RTV can grow as large as the spot market for the risky asset in question. Whereas Theta Vaults are bounded by the amount of matched options, RTVs are not given they do not require a marketplace.

\subsection{Fee Structure}

We follow Ribbon's fee model: Pareto's RTV takes a performance fee and a management fee if and only if the vault accrued yield that round. If spot price exceeds strike price (i.e in-the-money), no fees are taken. The performance fee is a percentage of the yield whereas the management fee is a percentage of the assets in the vault. These percentages are set at contract deployment and can be changed only by the contract owner.

\subsection{Benefits}

Beyond what is already been described on swapping buyers for arbitrageurs, there are a few more benefits of the RTV design. First, fees are paid throughout the round, rather than at a fixed point in time (e.g. an auction). For users, this provides a more flexible system for withdrawing capital. Their assets are never locked as collateral into another protocol, and can be withdrawn from RMM-01 pools at any point. Further, since Theta Vaults flood the options market with large options contracts in a consistent schedule, this has unintended consequences in market dynamics. For one, the sudden increase in supply reduces the value of the option being sold. This is not the case in RTVs specifically because premium (a.k.a. fees) are earned over time. Second, since participating in an RTV is providing liquidity to AMM, it has legally distinct from buying or selling options.

\subsection{Limitations}

Benefits aside, RTVs propose new challenges of its own. First, it still requires strike price to be set either automatically or manually. In the case of the former, this requires an oracle. Further, creating an RMM-01 pool requires setting the implied volatility of the underlying Black-Scholes model, for which the optimal value is the true volatility of the risky asset at the current time. This can be difficult to measure and requires an oracle as well. As such, RTVs would still benefit from a priviledged manager role.

\section{Conclusion and Future Work}

We have provided a technical description for a new design of Theta Vaults built on Replicating Market Makers, aptly named Replicating Theta Vaults. RTVs provide a yield mechanism by which users replicate the premium of selling covered calls by providing liquidity to an token swap pool. The proposed approach has potential capital efficiency benefits at the cost of rebalancing costs.
An RTV protocol is currently being designed by the Pareto team.

Covered calls are only one structured product that can be replicated by RMM-01. Others include calls, puts, binary options, strangles, condors, etc. Similar vaults can be designed for a larger options ecosystem built on replication.

\bibliographystyle{unsrt}
\bibliography{main}

\end{document}
